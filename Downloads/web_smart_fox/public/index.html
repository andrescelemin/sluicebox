<!DOCTYPE html>
<html lang="es">
  <head>
    <!-- PERFORMANCE HINTS -->
    <link rel="preconnect" href="https://server-side-tagging-f3s6cbxlba-uc.a.run.app" crossorigin>
    <link rel="dns-prefetch" href="https://server-side-tagging-f3s6cbxlba-uc.a.run.app">
    <link rel="preconnect" href="https://connect.facebook.net" crossorigin>
    <link rel="dns-prefetch" href="https://connect.facebook.net">
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

    <meta charset="UTF-8" />
    <meta http-equiv="x-ua-compatible" content="IE=edge">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#047857" />

    <!-- SEO -->
    <title>Agentes IA - Soluciones de Inteligencia Artificial</title>
    <meta name="description" content="Automatiza ventas, soporte y operaciones con agentes IA autónomos entrenados con tu conocimiento y conectados a tus herramientas." />
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
    <link rel="canonical" href="https://www.agentes-inteligencia-artificial.online/" />
    <link rel="sitemap" type="application/xml" href="/sitemap.xml" />
    <meta name="keywords" content="agentes de IA, inteligencia artificial para empresas, automatización WhatsApp, chatbots, CRM, soporte 24/7, ventas automatizadas" />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="es_PE" />
    <meta property="og:site_name" content="Agentes IA" />
    <meta property="og:title" content="Agentes IA - Soluciones de Inteligencia Artificial" />
    <meta property="og:description" content="Automatiza ventas, soporte y operaciones con agentes IA conectados a WhatsApp, web y CRM." />
    <meta property="og:url" content="https://www.agentes-inteligencia-artificial.online/" />
    <meta property="og:image" content="https://www.agentes-inteligencia-artificial.online/og-image.jpg" />
    <meta property="og:image:secure_url" content="https://www.agentes-inteligencia-artificial.online/og-image.jpg" />
    <meta property="og:image:alt" content="Agentes de IA para ventas, soporte y automatización 24/7" />
    <link rel="preload" as="image" href="https://www.agentes-inteligencia-artificial.online/og-image.jpg" imagesrcset="https://www.agentes-inteligencia-artificial.online/og-image.jpg 1200w">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Agentes IA - Soluciones de Inteligencia Artificial" />
    <meta name="twitter:description" content="Automatiza ventas, soporte y operaciones con agentes IA conectados a tus herramientas." />
    <meta name="twitter:image" content="https://www.agentes-inteligencia-artificial.online/og-image.jpg" />

    <!-- CONSENT MODE v2 (base estable) -->
    <script>
      (function(w){
        w.dataLayer = w.dataLayer || [];
        function gtag(){w.dataLayer.push(arguments);}
        w.gtag = gtag;
        gtag('consent','default',{
          ad_storage:'granted',
          ad_user_data:'granted',
          ad_personalization:'granted',
          analytics_storage:'granted',
          functionality_storage:'granted',
          security_storage:'granted',
          wait_for_update:1500
        });
      })(window);
    </script>

    <!-- GOOGLE TAG MANAGER (Server-side) -->
    <script>
      (function(w,d,s,l,i){
        w[l]=w[l]||[];
        w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=d.getElementsByTagName(s)[0], j=d.createElement(s), dl=l!='dataLayer'?'&l='+l:'';
        j.async=true;
        j.src='https://server-side-tagging-f3s6cbxlba-uc.a.run.app/gtm.js?id='+i+'&env=1&auth=Fe7DODj5Eeuj1pAlh_jVDg'+dl;
        f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-P6NDDTSR');
    </script>

    <!-- META PIXEL (ID: 1077386280774473) -->
    <script>
      (function(w,d){
        try{
          if(w.fbq)return;
          var n=w.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};
          if(!w._fbq)w._fbq=n;
          n.push=n; n.loaded=!0; n.version='2.0'; n.queue=[];
          var t=d.createElement('script'); t.async=!0; t.src='https://connect.facebook.net/en_US/fbevents.js';
          var s=d.getElementsByTagName('script')[0]; s.parentNode.insertBefore(t,s);
        }catch(e){console.error('Pixel loader error',e);}
      })(window,document);

      (function(){
        try{
          var em=(window.userEmail||'').trim().toLowerCase()||undefined;
          var ph=(window.userPhone||''); ph = ph ? ('+'+String(ph).replace(/\D+/g,'')) : undefined;
          var fn=(window.firstName||'').trim()||undefined;
          var ln=(window.lastName||'').trim()||undefined;
          var externalId=(window.userId||'').toString().trim()||undefined;
          if(typeof fbq==='function'){ fbq('init','1077386280774473',{em,ph,fn,ln,external_id:externalId}); fbq('track','PageView'); }
        }catch(e){console.error('Pixel init error',e);}
      })();
    </script>
    <noscript>
      <img height="1" width="1" style="display:none"
           src="https://www.facebook.com/tr?id=1077386280774473&ev=PageView&noscript=1"/>
    </noscript>

    <!-- n8n Chat CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />
  </head>

  <body>
    <!-- GTM (noscript) -->
    <noscript>
      <iframe src="https://server-side-tagging-f3s6cbxlba-uc.a.run.app/ns.html?id=GTM-P6NDDTSR&env=1&auth=Fe7DODj5Eeuj1pAlh_jVDg"
              height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>

    <!-- Contenedor de tu app -->
    <div id="root"></div>

    <!-- Bundle principal -->
    <script type="module" src="/src/main.tsx"></script>

    <!-- n8n Chat Widget + Instrumentación de Embudo -->
    <script type="module">
      import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';

      // --- Utilidades de tracking unificadas (GA4 + FB) ---
      function track(name, params){
        try { window.dataLayer && window.dataLayer.push({ event: name, ...params }); } catch(_) {}
        try { typeof window.gtag === 'function' && window.gtag('event', name, params || {}); } catch(_) {}
        try { typeof window.fbq  === 'function' && window.fbq('trackCustom', name, params || {}); } catch(_) {}
      }

      // 1) Marca de que el widget se cargó
      track('chat_widget_loaded', { widget: 'n8n' });

      // 2) Hook para apertura del chat (heurística no intrusiva)
      let chatOpenedOnce = false;
      window.addEventListener('click', () => {
        if (!chatOpenedOnce) {
          chatOpenedOnce = true;
          track('chat_opened', { widget: 'n8n' });
        }
      }, { capture: true });

      // 3) Interceptor de fetch: detecta envíos al webhook de n8n
      (function interceptFetch(){
        const TARGET = 'https://wsworkflow-n8n.vn0m5y.easypanel.host/webhook/5643dc77-ef2a-45c6-bbf6-0eb6de813f6e/chat';
        const _fetch = window.fetch;
        window.fetch = async function(input, init){
          try {
            const url = (typeof input === 'string') ? input : (input && input.url) || '';
            const method = (init && init.method) || (input && input.method) || 'GET';
            const isChat = url.indexOf(TARGET) === 0 && method.toUpperCase() === 'POST';

            if (isChat) {
              track('chat_message_sent', { widget: 'n8n' });

              // Intento seguro de clonar/leer el body para detectar señales de lead (no guardamos PII)
              try {
                let payloadText = '';
                if (init && init.body && typeof init.body === 'string') {
                  payloadText = init.body;
                } else if (init && init.body instanceof Blob) {
                  payloadText = await init.body.text();
                }
                const lowered = (payloadText || '').toLowerCase();
                const maybeLead = /email|correo|whatsapp|phone|tel|contact/i.test(lowered);
                if (maybeLead) {
                  track('chat_lead_signal', { widget: 'n8n' });
                }
              } catch(_) {}
            }

            const resp = await _fetch.apply(this, arguments);

            // Si la respuesta fue OK y venía del chat, marcamos intent por respuesta correcta
            try {
              if (isChat && resp && resp.ok) {
                track('chat_message_server_ok', { widget: 'n8n', status: resp.status });
              }
            } catch(_) {}

            return resp;
          } catch (e) {
            track('chat_message_error', { widget: 'n8n' });
            throw e;
          }
        };
      })();

      // 4) Inicializa el widget (tu trigger)
      createChat({
        webhookUrl: 'https://wsworkflow-n8n.vn0m5y.easypanel.host/webhook/5643dc77-ef2a-45c6-bbf6-0eb6de813f6e/chat',
        defaultLanguage: 'es',
        mode: 'window',
        theme: { primaryColor: '#047857' },
        enableStreaming: true,
        loadPreviousSession: true,
        // Puedes añadir mensajes iniciales si lo deseas:
        // initialMessages: ["¡Hola! 👋 Soy tu asistente IA.", "¿Quieres automatizar atención o ventas?"],
      });
    </script>

    <!-- SPA: re-dispara PageView en cambios de ruta (Meta) -->
    <script>
      (function(){
        try{
          var _origPush=history.pushState;
          history.pushState=function(){ _origPush.apply(history,arguments); try{ typeof fbq==="function" && fbq("track","PageView"); }catch(_){} };
          window.addEventListener("popstate", function(){ try{ typeof fbq==="function" && fbq("track","PageView"); }catch(_){} });
        }catch(e){ console.warn("SPA PageView hook error", e); }
      })();
    </script>

    <!-- Health checks no bloqueantes -->
    <script>
      setTimeout(function(){
        console.log(typeof window.fbq==="function" ? "✅ Pixel OK (1077386280774473)" : "⚠️ Pixel no cargó");
        console.log(Array.isArray(window.dataLayer) ? "✅ dataLayer OK" : "⚠️ dataLayer no inicializada");
      }, 2000);
    </script>

    <!-- JSON-LD (Organization + WebSite) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@graph": [
        {
          "@type": "Organization",
          "name": "Agentes IA",
          "url": "https://www.agentes-inteligencia-artificial.online/",
          "logo": "https://www.agentes-inteligencia-artificial.online/og-image.jpg",
          "sameAs": [
            "https://www.facebook.com/AgentesIA",
            "https://www.instagram.com/AgentesIA",
            "https://www.linkedin.com/company/agentes-ia"
          ]
        },
        {
          "@type": "WebSite",
          "url": "https://www.agentes-inteligencia-artificial.online/",
          "name": "Agentes IA - Soluciones de Inteligencia Artificial",
          "potentialAction": {
            "@type": "SearchAction",
            "target": "https://www.agentes-inteligencia-artificial.online/?s={search_term_string}",
            "query-input": "required name=search_term_string"
          },
          "inLanguage": "es-PE"
        }
      ]
    }
    </script>
  </body>
</html>
